{% extends "plugins/admin/templates/partials/base.html" %}

{% block content %}

    <div class="flex row">
        <div class="col w-full">
            <form method="post" id="form" class="form-inline form-upload" enctype="multipart/form-data" action="{{ path_for('admin.entries.uploadMediaFileProcess') }}">
                {{ csrf() }}
                <input type="hidden" name="entry-id" value="{{ id }}">
                <div class="form-group bg-gray-000 p-4">
                    <input type="submit" id="upload_file" name="upload_file" value="{{ tr('admin_upload') }}" class="button">
                    <input name="file" type="file" class="w-100">
                </div>
            </form>
        </div>
    </div>

    {% set allowed_image_files = ['jpeg', 'png', 'gif', 'jpg'] %}

    <table class="table">
        <thead>
            <tr>
                <th>
                    {{ tr('admin_file') }}
                </th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
                <tr
                    id="file_{{ loop.index0 }}"
                    data-direct-link="{{ site_url() }}/site/uploads/entries/{{ id }}/{{ filesystem_basename(file) }}"
                    data-delivery-images-api-link="{{ site_url() }}/api/delivery/images/{{ id }}/{{ filesystem_basename(file) }}?token={{ registry.flextype.api.images.default_token }}">
                    <td style="height: 64px;">
                        {{ filesystem_basename(file) }}
                    </td>
                    <td class="text-center flex justify-center" style="height: 64px;">
                        {% if (filesystem_ext(file) in allowed_image_files) %}
                            <img src="{{ site_url() }}/api/delivery/images/{{ id }}/{{ filesystem_basename(file) }}?w=64&q=70&dpr=2&token={{ registry.flextype.api.images.default_token }}" alt="" class="border-2 rounded border-gray-200" style="height: 50px;">
                        {% endif %}
                    </td>
                    <td class="text-right" style="height: 64px;">
                        <button type="button" class="js-dropdown-btn" data-dropdown="dropdown-{{ id }}">
                            <i class="icon">{{ icon('fas fa-ellipsis-h') }}</i>
                        </button>
                        <div id="dropdown-{{ id }}" class="dropdown">
                            <a class="dropdown__item js-snippets-info" href="javascript:;" onclick="event.preventDefault();
                            embededCode('{{ filesystem_basename(file) }}', {{ loop.index0 }});">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-code') }}</i>
                                {{ tr('admin_embeded_code') }}</a>
                            <div class="dropdown__divider"></div>
                            <a class="dropdown__item" href="javascript:;" onclick="event.preventDefault();
                            deleteSnippet('{{ id }}', {{ loop.index0 }});">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-trash-alt') }}</i>
                                {{ tr('admin_delete') }}</a>
                            <form id="delete-snippet-id-{{ id }}" action="{{ path_for('admin.snippets.deleteProcess') }}" method="POST" style="display: none;">
                                {{ csrf() }}
                                <input type="hidden" name="snippet-id" value="{{ id }}">
                            </form>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="_embeded-code-template hidden">
        <div class="form-group">
            <label for="shortcode" class="form-control-title text-left">{{ tr('admin_direct_link') }}</label>
            <textarea class="js-direct-link form-control" style="height: 82px;"></textarea>
        </div>
        <div class="form-group">
            <label for="shortcode" class="form-control-title text-left">{{ tr('admin_delivery_images_api_link') }}</label>
            <textarea class="js-delivery-images-api-link form-control" style="height: 82px;"></textarea>
        </div>
    </div>

    <br>

    {#
    <div class="flex row">
        {% for file in files %}
            <div class="col w-3/12 flex row justify-center items-center relative p-10 mb-2">
                {% if (filesystem_ext(file) in allowed_image_files) %}
                    <img src="{{ base_url() }}/api/delivery/images/{{ id }}/{{ filesystem_basename(file) }}?w=240&q=70&dpr=2&token={{ registry.flextype.api.images.default_token }}" alt="" class="bg-gray-000 p-10">
                {% endif %}
            </div>
        {% endfor %}
    </div>


    <div class="modal animated fadeIn faster image-preview-modal" id="entriesImagePreview" tabindex="-1" role="dialog" aria-labelledby="entriesImagePreviewLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entriesImagePreviewLabel">{{ tr('admin_preview') }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body js-entry-image-preview-placeholder image-preview"></div>
                <div class="modal-footer">
                    <input type="text" name="" class="form-control js-entry-image-url-placeholder" value="">
                    <form id="delete-media-file" action="{{ path_for('admin.entries.deleteMediaFileProcess') }}" method="POST" style="display: none;">
                        {{ csrf() }}
                        <input type="hidden" name="media-id" class="js-media-id" value="">
                        <input type="hidden" name="entry-id" class="js-entry-id" value="">
                    </form>
                    <a class="buttonbtn-primary" href="javascript:;" onclick="event.preventDefault();
                      document.getElementById('delete-media-file').submit();">{{ tr('admin_delete') }}</a>

                </div>
            </div>
        </div>
    </div>
#}
{% endblock %}

{% block tail %}
    <script>
        function embededCode(id, row_num) {
            if (dropdown[row_num]) {
                dropdown[row_num].hide();
            }
            Swal.fire({
                title: "{{ tr('admin_embeded_code') }}",
                showCloseButton: true,
                focusCloseButton: false,
                showConfirmButton: false,
                html: $('._embeded-code-template').html(),
                onBeforeOpen: () => {
                    $('.js-direct-link').val($('#file_' + row_num).attr('data-direct-link'));
                    $('.js-delivery-images-api-link').val($('#file_' + row_num).attr('data-delivery-images-api-link'));
                }
            });
        }
    </script>
{% endblock %}