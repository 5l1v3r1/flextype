{% extends "plugins/admin/templates/partials/base.html" %}

{% block content %}
    {% if entries_list | length > 0 %}
        {% if items_view == 'table' %}
            <div class="flex flex-wrap">
                {% for entry in entries_list %}
                    {% if cache.contains(entry.slug ~ '_counter') %}
                        {% set _entries_length = cache.fetch(entry.slug ~ '_counter') %}
                    {% else %}
                        {% set _entries = entries.fetch(entry.slug, {}) %}
                        {% set _entries_length = _entries | length %}
                        {% do
                            cache.save(entry.slug ~ '_counter', _entries_length) %}
                    {% endif %}
                    <div class="w-full md:w-3/12 lg:w-2/12 text-center p-4 relative">
                        <button type="button" class="js-dropdown-btn" style="top: 16px; right: 16px; position: absolute; z-index: 10; width: 34px; height: 34px;">
                            <i class="icon">{{ icon('fas fa-ellipsis-h') }}</i>
                        </button>
                        <div class="js-dropdown dropdown">
                            <a class="dropdown__item" href="{{ path_for('admin.entries.edit') }}?id={{ entry.slug }}&type=editor">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-edit') }}</i>
                                {{ tr('admin_edit') }}</a>
                            <a class="dropdown__item" href="javascript:;" onclick="$('.js-add-entry input[name=id]').attr('value', '{{ entry.slug }}');" data-toggle="modal" data-target="#selectEntryTypeModal">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-plus-circle') }}</i>
                                {{ tr('admin_add') }}</a>
                            <a class="dropdown__item" href="javascript:;" onclick="event.preventDefault();
                                   document.getElementById('duplicate-id-{{ entry.slug }}').submit();">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-copy') }}</i>
                                {{ tr('admin_duplicate') }}</a>
                            <a class="dropdown__item" href="{{ path_for('admin.entries.rename') }}?id={{ entry.slug }}">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-font') }}</i>
                                {{ tr('admin_rename') }}</a>
                            <a class="dropdown__item" href="{{ path_for('admin.entries.move') }}?id={{ entry.slug }}">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-angle-double-right') }}</i>
                                {{ tr('admin_move') }}</a>
                            <a class="dropdown__item" href="{{ base_url() }}/{{ entry.slug }}" target="_blank">
                                <i class="icon icon--white mr-3">{{ icon('fas fa-eye') }}</i>
                                {{ tr('admin_preview') }}</a>
                            <a class="dropdown__item" href="{{ path_for('admin.entries.type') }}?id={{ entry.slug }}">
                                <i class="icon icon--white mr-3">{{ icon('far fa-list-alt') }}</i>
                                {{ tr('admin_type') }}</a>
                            <div class="dropdown__divider"></div>
                            <a class="dropdown__item" href="javascript:;" onclick="event.preventDefault();
                                   document.getElementById('delete-id-{{ entry.slug }}').submit();">
                                <i class="icon">{{ icon('fas fa-trash-alt') }}</i>
                                {{ tr('admin_delete') }}</a>
                            <form id="duplicate-id-{{ entry.slug }}" action="{{ path_for('admin.entries.duplicateProcess') }}" method="POST" style="display: none;">
                                {{ csrf() }}
                                <input type="hidden" name="id" value="{{ entry.slug }}">
                            </form>
                            <form id="delete-id-{{ entry.slug }}" action="{{ path_for('admin.entries.deleteProcess') }}" method="POST" style="display: none;">
                                {{ csrf() }}
                                <input type="hidden" name="id" value="{{ entry.slug }}">
                                <input type="hidden" name="id-current" value="{{ id_current }}">
                            </form>
                        </div>

                        <a
                            href="{% if _entries_length > 0 %}{{ path_for('admin.entries.index') }}?id={{ entry.slug }}{% else %}{{ path_for('admin.entries.edit') }}?id={{ entry.slug }}&type=editor{% endif %}"
                            class="block bg-gray-000 border-gray-100 border px-4 py-8 relative">

                            <div class="text-4xl">
                                {% if entry.fieldset %}
                                    {% set fieldset_path = PATH_FIELDSETS ~ '/' ~ entry.fieldset ~ '.yaml' %}
                                    {% if filesystem_has(fieldset_path) %}
                                        {% set fieldset = parser_decode(filesystem_read(fieldset_path), 'yaml') %}
                                        {% if fieldset.icon %}
                                            <i class="{{ fieldset.icon }}"></i>
                                        {% else %}
                                            <i class="far fa-file-alt"></i>
                                        {% endif %}
                                    {% else %}
                                        <i class="far fa-file-alt"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="far fa-file-alt"></i>
                                {% endif %}
                            </div>
                            <div>
                                {% if entry.fieldset %}
                                    {% if filesystem_has(fieldset_path) %}
                                        {% if fieldset.default_field %}
                                            {% if entry[fieldset.default_field] != '' %}
                                                {{ entry[fieldset.default_field] }}
                                            {% else %}
                                                {{ entry.slug }}
                                            {% endif %}
                                        {% else %}
                                            {{ entry.slug }}
                                        {% endif %}
                                    {% else %}
                                        {{ entry.slug }}
                                    {% endif %}
                                {% else %}
                                    {{ entry.slug }}
                                {% endif %}
                                {% if _entries_length > 0 %}
                                    ({{ _entries_length }})
                                {% endif %}
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <table class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th>
                            {{ tr('admin_title') }}
                        </th>
                        <th>
                            {{ tr('admin_slug') }}
                        </th>
                        <th>
                            {{ tr('admin_created_at') }}
                        </th>
                        <th>
                            {{ tr('admin_updated_at') }}
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries_list %}
                        <tr>
                            <td class="w-1 text-center {% if entry.visibility == 'hidden' or entry.visibility == 'draft' or entry.routable == false %}opacity-50{% endif %}">
                                {% if entry.fieldset %}
                                    {% set fieldset_path = PATH_FIELDSETS ~ '/' ~ entry.fieldset ~ '.yaml' %}
                                    {% if filesystem_has(fieldset_path) %}
                                        {% set fieldset = parser_decode(filesystem_read(fieldset_path), 'yaml') %}
                                        {% if fieldset.icon %}
                                            <i class="icon">{{ icon(fieldset.icon) }}</i>
                                        {% else %}
                                            <i class="icon">{{ icon(fieldset.icon) }}</i>
                                        {% endif %}
                                    {% else %}
                                        <i class="icon">{{ icon(fieldset.icon) }}</i>
                                    {% endif %}
                                {% else %}
                                    <i class="icon">{{ icon(fieldset.icon) }}</i>
                                {% endif %}
                            </td>
                            <td class="pl-0 {% if entry.visibility == 'hidden' or entry.visibility == 'draft' or entry.routable == false %}opacity-50{% endif %}">
                                {% if cache.contains(entry.slug ~ '_counter') %}
                                    {% set _entries_length = cache.fetch(entry.slug ~ '_counter') %}
                                {% else %}
                                    {% set _entries = entries.fetch(entry.slug, {}) %}
                                    {% set _entries_length = _entries | length %}
                                    {% do
                                        cache.save(entry.slug ~ '_counter', _entries_length) %}
                                {% endif %}
                                <a href="{% if _entries_length > 0 %}{{ path_for('admin.entries.index') }}?id={{ entry.slug }}{% else %}{{ path_for('admin.entries.edit') }}?id={{ entry.slug }}&type=editor{% endif %}">
                                    {% if entry.fieldset %}
                                        {% if filesystem_has(fieldset_path) %}
                                            {% if fieldset.default_field %}
                                                {% if entry[fieldset.default_field] != '' %}
                                                    {{ entry[fieldset.default_field] }}
                                                {% else %}
                                                    {{ entry.slug }}
                                                {% endif %}
                                            {% else %}
                                                {{ entry.slug }}
                                            {% endif %}
                                        {% else %}
                                            {{ entry.slug }}
                                        {% endif %}
                                    {% else %}
                                        {{ entry.slug }}
                                    {% endif %}
                                    {% if _entries_length > 0 %}
                                        ({{ _entries_length }})
                                    {% endif %}
                                </a>
                            </td>
                            <td class="truncate">
                                /
                                {{ entry.slug }}
                            </td>
                            <td>
                                {{ entry.created_at }}
                            </td>
                            <td>
                                {{ entry.published_at }}
                            </td>
                            <td class="text-right">
                                <button type="button" class="js-dropdown-btn relative">
                                    <i class="icon">{{ icon('fas fa-ellipsis-h') }}</i>
                                </button>
                                <div class="js-dropdown dropdown">
                                    <a class="dropdown__item" href="{{ path_for('admin.entries.edit') }}?id={{ entry.slug }}&type=editor">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-edit') }}</i>
                                        {{ tr('admin_edit') }}</a>
                                    <a class="dropdown__item" href="javascript:;" onclick="$('.js-add-entry input[name=id]').attr('value', '{{ entry.slug }}');" data-toggle="modal" data-target="#selectEntryTypeModal">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-plus-circle') }}</i>
                                        {{ tr('admin_add') }}</a>
                                    <a class="dropdown__item" href="javascript:;" onclick="event.preventDefault();
                                           document.getElementById('duplicate-id-{{ entry.slug }}').submit();">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-copy') }}</i>
                                        {{ tr('admin_duplicate') }}</a>
                                    <a class="dropdown__item" href="{{ path_for('admin.entries.rename') }}?id={{ entry.slug }}">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-font') }}</i>
                                        {{ tr('admin_rename') }}</a>
                                    <a class="dropdown__item" href="{{ path_for('admin.entries.move') }}?id={{ entry.slug }}">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-angle-double-right') }}</i>
                                        {{ tr('admin_move') }}</a>
                                    <a class="dropdown__item" href="{{ base_url() }}/{{ entry.slug }}" target="_blank">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-eye') }}</i>
                                        {{ tr('admin_preview') }}</a>
                                    <a class="dropdown__item" href="{{ path_for('admin.entries.type') }}?id={{ entry.slug }}">
                                        <i class="icon icon--white mr-3">{{ icon('far fa-list-alt') }}</i>
                                        {{ tr('admin_type') }}</a>
                                    <div class="dropdown__divider"></div>
                                    <a class="dropdown__item" href="javascript:;" onclick="event.preventDefault();
                                           document.getElementById('delete-id-{{ entry.slug }}').submit();">
                                        <i class="icon icon--white mr-3">{{ icon('fas fa-trash-alt') }}</i>
                                        {{ tr('admin_delete') }}</a>
                                    <form id="duplicate-id-{{ entry.slug }}" action="{{ path_for('admin.entries.duplicateProcess') }}" method="POST" style="display: none;">
                                        {{ csrf() }}
                                        <input type="hidden" name="id" value="{{ entry.slug }}">
                                    </form>
                                    <form id="delete-id-{{ entry.slug }}" action="{{ path_for('admin.entries.deleteProcess') }}" method="POST" style="display: none;">
                                        {{ csrf() }}
                                        <input type="hidden" name="id" value="{{ entry.slug }}">
                                        <input type="hidden" name="id-current" value="{{ id_current }}">
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    {% else %}
        <div class="empty-list-message">
            <i class="far fa-newspaper"></i>
            <h3>{{ tr('admin_you_have_not_created_any_entries_yet') }}</h3>
            <a href="javascript:;" data-toggle="modal" data-target="#selectEntryTypeModal" class="btn">{{ tr('admin_create_new_entry') }}</a>
        </div>
    {% endif %}

    <div class="modal fade hidden" id="selectEntryTypeModal" tabindex="-1" role="dialog" aria-labelledby="selectEntryTypeModal" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectEntryTypeModalLabel">{{ tr('admin_select_entry_type') }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="fieldset-selector row">
                        {% for key, fieldset in fieldsets %}
                            <li class="col-md-4">
                                <a href="javascript:;" onclick="event.preventDefault();
                                document.getElementById('add-entry-{{ key }}').submit();" class="fieldset-item">
                                    <div class="fieldset-thumbnail">
                                        {% if fieldset.icon %}
                                            <i class="{{ fieldset.icon }}"></i>
                                        {% else %}
                                            <i class="far fa-file-alt"></i>
                                        {% endif %}
                                    </div>
                                    <div class="fieldset-title">{{ fieldset.title }}</div>
                                </a>
                            </li>
                            <form id="add-entry-{{ key }}" action="{{ path_for('admin.entries.selectEntryTypeProcess') }}" method="POST" style="display: none;" class='js-add-entry'>
                                {{ csrf() }}
                                <input type="hidden" name="type" value="{{ key }}">
                                <input type="hidden" name="id" value="{{ id_current }}">
                            </form>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
